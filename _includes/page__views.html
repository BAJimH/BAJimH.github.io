{% if page.id %}
  <div class="page__views" style="margin-top: 2em; padding-top: 1em; border-top: 1px solid #e8e8e8;">
    <span class="page__views-label" style="color: #999; font-size: 0.875em; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
      <i class="fa fa-eye" aria-hidden="true"></i> 阅读量：
    </span>
    <span id="post-views-count" style="color: #999; font-size: 0.875em; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
      加载中...
    </span>
  </div>
  
  {% if site.leancloud.enabled %}
    <!-- LeanCloud 阅读量统计 -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <script>
      (function() {
        // 检查配置是否存在
        var appId = '{{ site.leancloud.app_id }}';
        var appKey = '{{ site.leancloud.app_key }}';
        var serverURL = '{{ site.leancloud.server_url }}';
        
        if (!appId || !appKey || !serverURL) {
          console.error('LeanCloud 配置不完整:', {appId: appId, appKey: appKey, serverURL: serverURL});
          document.getElementById('post-views-count').textContent = '配置错误';
          return;
        }
        
        // 等待 AV 对象加载
        if (typeof AV === 'undefined') {
          console.error('LeanCloud SDK 未加载');
          document.getElementById('post-views-count').textContent = 'SDK加载失败';
          return;
        }
        
        // 初始化 LeanCloud
        try {
          AV.init({
            appId: appId,
            appKey: appKey,
            serverURL: serverURL
          });
          console.log('LeanCloud 初始化成功');
        } catch (error) {
          console.error('LeanCloud 初始化失败:', error);
          document.getElementById('post-views-count').textContent = '初始化失败';
          return;
        }

        // 获取当前页面的唯一标识（使用URL作为标识）
        const pageUrl = window.location.pathname;
        const pageTitle = '{{ page.title | escape }}';
        
        // 更新阅读量
        function updatePostViews() {
          try {
            const PostViews = AV.Object.extend('PostViews');
            const query = new AV.Query('PostViews');
            
            // 使用URL作为唯一标识
            query.equalTo('url', pageUrl);
            
            query.first().then(function(post) {
              if (post) {
                // 文章已存在，增加阅读量
                post.increment('views', 1);
                post.save().then(function() {
                  const views = post.get('views');
                  document.getElementById('post-views-count').textContent = views;
                  console.log('阅读量更新成功:', views);
                }).catch(function(error) {
                  console.error('更新阅读量失败:', error);
                  document.getElementById('post-views-count').textContent = post.get('views') || 0;
                });
              } else {
                // 文章不存在，创建新记录
                const newPost = new PostViews();
                newPost.set('url', pageUrl);
                newPost.set('title', pageTitle);
                newPost.set('views', 1);
                newPost.save().then(function() {
                  document.getElementById('post-views-count').textContent = '1';
                  console.log('创建阅读量记录成功');
                }).catch(function(error) {
                  console.error('创建阅读量记录失败:', error);
                  document.getElementById('post-views-count').textContent = '0';
                });
              }
            }).catch(function(error) {
              console.error('查询阅读量失败:', error);
              document.getElementById('post-views-count').textContent = '加载失败';
            });
          } catch (error) {
            console.error('更新阅读量时发生错误:', error);
            document.getElementById('post-views-count').textContent = '加载失败';
          }
        }

        // 页面加载完成后更新阅读量
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', updatePostViews);
        } else {
          updatePostViews();
        }
      })();
    </script>
  {% else %}
    <!-- 不蒜子阅读量统计（备选方案） -->
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <script>
      // 确保不蒜子使用页面URL作为唯一标识
      (function() {
        // 等待不蒜子加载完成
        function checkBusuanzi() {
          if (typeof busuanzi !== 'undefined') {
            const countElement = document.getElementById('busuanzi_value_page_pv');
            if (countElement && countElement.textContent === '') {
              countElement.textContent = '0';
            }
            // 不蒜子会自动根据页面URL统计，这里不需要额外配置
          } else {
            setTimeout(checkBusuanzi, 100);
          }
        }
        checkBusuanzi();
      })();
    </script>
    <span id="busuanzi_container_page_pv" style="display: none;">
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <script>
      // 将不蒜子的值同步到显示元素
      (function() {
        function syncBusuanziCount() {
          const busuanziElement = document.getElementById('busuanzi_value_page_pv');
          const displayElement = document.getElementById('post-views-count');
          if (busuanziElement && displayElement && busuanziElement.textContent && busuanziElement.textContent !== '') {
            displayElement.textContent = busuanziElement.textContent;
          } else {
            setTimeout(syncBusuanziCount, 500);
          }
        }
        setTimeout(syncBusuanziCount, 1000);
      })();
    </script>
  {% endif %}
{% endif %}

